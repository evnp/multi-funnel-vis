<html>
	<head>
		<link href="/css/reset.css" rel="stylesheet" type="text/css">
		<link href="/css/main.css" rel="stylesheet" type="text/css">
	</head>
	<body>
		<script src="/js/three.min.js"></script>
		<script src="/js/OrbitControls.js"></script>
		<script src="/js/helvetiker_regular.typeface.js"></script>
		<script type="text/javascript">
			var camera, scene, renderer;
			var geometry, material, mesh;

			var data = {"nodes": [{"count": 4505, "event": "homepage new"}, {"count": 496, "event": "Tutorial Shown"}, {"count": 488, "event": "Viewed report"}, {"count": 876, "event": "Viewed login page"}], "maxLinkCount": 4505, "links": [{"count": 496, "source": 0, "target": 1}, {"count": 488, "source": 0, "target": 2}, {"count": 149, "source": 2, "target": 1}, {"count": 876, "source": 0, "target": 3}, {"count": 212, "source": 3, "target": 1}, {"count": 409, "source": 3, "target": 2}], "maxNodeCount": 4505};

			var funnelMarkers = {};

			init();
			animate();

			function init() {

				camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 1000);
				camera.position.z = 100;

				scene = new THREE.Scene();

				var directionalLight = new THREE.DirectionalLight( 0xffffff, 0.75 );
				directionalLight.position.set( 0, 1, 0 );
				scene.add( directionalLight );

				var light = new THREE.PointLight( 0xffffff, 0.8, 100 );
				light.position.set( 0, 20, 20 );
				scene.add( light );

				renderer = new THREE.WebGLRenderer({ antialias: true });
				renderer.setClearColor(0xf9fbfc);
				renderer.setSize(window.innerWidth, window.innerHeight);

    			controls = new THREE.OrbitControls(camera, renderer.domElement);

				// var marker1 = createFunnelMarker("My Funnel");
				// marker1.position.x = -10;
				// scene.add(marker1);

				// var marker2 = createFunnelMarker("Another Funnel");
				// marker2.position.x = 10;
				// marker2.position.y = 10;
				// scene.add(marker2);

				// connectFunnelMarkers(marker1, marker2);

				// var marker3 = createFunnelMarker("Another Funnel");
				// marker3.position.x = 10;
				// marker3.position.y = -20;
				// scene.add(marker3);

				// connectFunnelMarkers(marker1, marker3);


				// // Example text options : {'font' : 'helvetiker','weight' : 'normal', 'style' : 'normal','size' : 100,'curveSegments' : 300};

				document.body.appendChild(renderer.domElement);

				window.addEventListener('resize', function () {
				  renderer.setSize(window.innerWidth, window.innerHeight);
				  camera.aspect = window.innerWidth / window.innerHeight;
				  camera.updateProjectionMatrix();
				});

				parseData(data);
			}

			function parseData(data) {
				var nodes = data.nodes;
				for (var i = nodes.length - 1; i >= 0; i--) {
					var pastHalf = (i >= nodes.length * 0.5)
					var node = nodes[i];
					var marker = createFunnelMarker(node.event);
					marker.position.x = pastHalf ? 50 : -50;
					marker.position.y = Math.random() * 100 - 50;
					marker.position.z = Math.random() * 20 - 10;
					scene.add(marker);

					funnelMarkers[i] = marker;
				};

				var links = data.links;
				for (var i = links.length - 1; i >= 0; i--) {
					var link = links[i];
					connectFunnelMarkers(funnelMarkers[link.source], funnelMarkers[link.target], 3);
				};
			}

			function createFunnelMarker(name) {
				var object = new THREE.Object3D();

				var geometry = new THREE.CylinderGeometry( 5, 5, 2, 32 );
				var material = new THREE.MeshPhongMaterial( { color: 0xff8a44, specular: 0xdddddd, shininess: 10, shading: THREE.SmoothShading } );
				var cylinder = new THREE.Mesh( geometry, material );
				cylinder.rotation.z = Math.PI / 2;
				cylinder.rotation.x = Math.PI / 2;

				object.add(cylinder);

				var textShapes = THREE.FontUtils.generateShapes( name, { "size": 2 } );
				var text = new THREE.ShapeGeometry( textShapes );
				text.computeBoundingBox();
				var textMesh = new THREE.Mesh( text, new THREE.MeshBasicMaterial( { color: 0x222222 } ) ) ;
				textMesh.position.y = -8;

				var textWidth = text.boundingBox.max.x - text.boundingBox.min.x;
				textMesh.position.x = -textWidth * 0.5;
				object.add(textMesh);

				return object;
			}

			function connectFunnelMarkers(funnel1, funnel2, width) {
				var point1 = new THREE.Vector3( 0, 0, 0 ).lerpVectors(funnel1.position, funnel2.position, 0.5);
				point1.y = funnel1.position.y;

				var point2 = new THREE.Vector3( 0, 0, 0 ).lerpVectors(funnel1.position, funnel2.position, 0.5);
				point2.y = funnel2.position.y;				
				var curve = new THREE.CubicBezierCurve3(
					funnel1.position,
					point1,
					point2,
					funnel2.position
				);

				var geometry = new THREE.Geometry();
				geometry.vertices = curve.getPoints( 50 );

				var material = new THREE.MeshPhongMaterial( { color: 0x2592ee, specular: 0xdddddd, shininess: 30, shading: THREE.SmoothShading } );
				var extrudedSpline = new THREE.TubeGeometry(curve, 64, width, 12, false);
				var mesh = new THREE.Mesh(extrudedSpline, material);

				scene.add(mesh);

				return mesh;
			}

			function animate() {
				requestAnimationFrame(animate);
				renderer.render(scene, camera);
				controls.update();
			}
		</script>
	</body>
</html>